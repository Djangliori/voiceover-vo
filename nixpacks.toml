# Explicitly set provider for faster detection
# Build optimization: Removed PyTorch/Whisper for 10x faster deploys
[providers]
python = "3.11"

[phases.setup]
nixPkgs = ["python311", "ffmpeg"]
# Create non-root user for running services
cmds = [
  "useradd -m -u 1000 appuser || true"
]

[phases.install]
# Use pip cache for faster rebuilds (cached between deploys)
cmds = [
  "pip install --upgrade pip wheel",
  "pip install -r requirements.txt --no-warn-script-location",
  "mkdir -p /app/temp",
  "chown -R appuser:appuser /app || true"
]

# Cache pip packages between builds for faster deploys
[phases.install.cacheDirectories]
paths = ["/root/.cache/pip"]

[start]
cmd = "gunicorn --bind 0.0.0.0:$PORT --workers 2 --threads 4 --timeout 600 app:app"
