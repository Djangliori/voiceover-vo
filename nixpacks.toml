# Explicitly set provider for faster detection
[providers]
python = "3.12"

[phases.setup]
nixPkgs = ["python312", "ffmpeg"]

[phases.install]
# Use pip cache for faster rebuilds (cached between deploys)
cmds = [
  "pip install --upgrade pip wheel",
  "pip install -r requirements.txt --no-warn-script-location"
]

# Cache pip and whisper models between builds for 10x faster deploys
[phases.install.cacheDirectories]
paths = ["/root/.cache/pip", "/root/.cache/whisper"]

# Pre-download Whisper model during build (not runtime)
[phases.build]
cmds = [
  "python3 -c 'import whisper; whisper.load_model(\"base\")'"
]

[start]
cmd = "gunicorn --bind 0.0.0.0:$PORT --workers 2 --threads 4 --timeout 600 app:app"
