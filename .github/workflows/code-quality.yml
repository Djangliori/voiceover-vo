name: Code Quality & Analysis

on:
  pull_request:
    branches: [main, develop]
  schedule:
    # Run weekly on Monday at 9am UTC
    - cron: '0 9 * * 1'
  workflow_dispatch:

jobs:
  # ==================================
  # Code Quality Analysis
  # ==================================
  quality-analysis:
    name: Code Quality Analysis
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Full history for better analysis

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.9'
          cache: 'pip'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install -r requirements-dev.txt
          pip install radon complexity-report

      - name: Run Radon (cyclomatic complexity)
        run: |
          radon cc src/ -a -nb --total-average > radon-cc-report.txt
          cat radon-cc-report.txt
        continue-on-error: true

      - name: Run Radon (maintainability index)
        run: |
          radon mi src/ -s > radon-mi-report.txt
          cat radon-mi-report.txt
        continue-on-error: true

      - name: Upload Radon reports
        uses: actions/upload-artifact@v4
        with:
          name: radon-reports
          path: |
            radon-cc-report.txt
            radon-mi-report.txt

  # ==================================
  # SonarCloud Analysis
  # ==================================
  sonarcloud:
    name: SonarCloud Analysis
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: SonarCloud Scan
        uses: SonarSource/sonarcloud-github-action@master
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
        with:
          args: >
            -Dsonar.projectKey=georgian-voiceover-app
            -Dsonar.organization=your-org
            -Dsonar.python.coverage.reportPaths=coverage.xml
            -Dsonar.sources=src,app.py,celery_app.py
            -Dsonar.tests=tests
            -Dsonar.python.version=3.9
        continue-on-error: true

  # ==================================
  # Dependency Audit
  # ==================================
  dependency-audit:
    name: Dependency Security Audit
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.9'

      - name: Install pip-audit
        run: |
          python -m pip install --upgrade pip
          pip install pip-audit

      - name: Run pip-audit
        run: |
          pip-audit --requirement requirements.txt --format json --output pip-audit-report.json
        continue-on-error: true

      - name: Upload audit report
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: pip-audit-report
          path: pip-audit-report.json

  # ==================================
  # License Compliance Check
  # ==================================
  license-check:
    name: License Compliance
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.9'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install pip-licenses

      - name: Generate license report
        run: |
          pip install -r requirements.txt
          pip-licenses --format=markdown --output-file=licenses.md
          cat licenses.md

      - name: Upload license report
        uses: actions/upload-artifact@v4
        with:
          name: license-report
          path: licenses.md

  # ==================================
  # Code Duplication Detection
  # ==================================
  duplication-check:
    name: Code Duplication Detection
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install PMD CPD
        run: |
          wget https://github.com/pmd/pmd/releases/download/pmd_releases%2F6.55.0/pmd-bin-6.55.0.zip
          unzip pmd-bin-6.55.0.zip

      - name: Run CPD
        run: |
          pmd-bin-6.55.0/bin/run.sh cpd --minimum-tokens 50 --files src/ --language python --format xml --report-file cpd-report.xml
        continue-on-error: true

      - name: Upload CPD report
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: duplication-report
          path: cpd-report.xml

  # ==================================
  # Comment PR with Quality Report
  # ==================================
  pr-comment:
    name: Comment on PR
    runs-on: ubuntu-latest
    needs: [quality-analysis, dependency-audit, license-check]
    if: github.event_name == 'pull_request'

    steps:
      - name: Download artifacts
        uses: actions/download-artifact@v4

      - name: Create quality summary
        id: summary
        run: |
          summary="## ðŸ“Š Code Quality Report\n\n"
          summary+="### âœ… Checks Completed\n"
          summary+="- Code quality analysis\n"
          summary+="- Dependency security audit\n"
          summary+="- License compliance check\n\n"
          summary+="### ðŸ“ Reports Available\n"
          summary+="Download artifacts from the Actions tab for detailed reports.\n"
          echo "summary=$summary" >> $GITHUB_OUTPUT

      - name: Comment PR
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: `${{ steps.summary.outputs.summary }}`
            })
